---
# To apply this manifest: cf push --vars-file vars.yml
applications:
  - name: ((app_name))-solr
    docker:
      image: ghcr.io/gsa/catalog.data.gov.solr
    routes:
      - route: ((solr_route))
  - name: ((app_name))
    buildpacks:
      - https://github.com/cloudfoundry/apt-buildpack
      - python_buildpack
    services:
      - ((app_name))-db
      - ((app_name))-redis
      - ((app_name))-secrets
    routes: ((routes))
    processes:
    - type: web
      instances: ((instances))
      command: ./cfsetup.sh ckan run --host "0.0.0.0" --port $PORT
      health-check-type: http
      health-check-http-endpoint: /dataset
      health-check-invocation-timeout: 10
    - type: harvest-gather
      instances: 1
      command: ./cfsetup.sh ckan harvester gather-consumer
      health-check-type: process
      timeout: 15
    - type: harvest-fetch
      instances: 1
      command: ./cfsetup.sh ckan harvester fetch-consumer
      health-check-type: process
      timeout: 15
    env:
      CKAN_SOLR_URL: http://((solr_route)):8983/solr/ckan
      CKANEXT__SAML2AUTH__IDP_METADATA__LOCAL_PATH: ((ckanext__saml2auth__idp_metadata__local_path))
      CKANEXT__SAML2AUTH__ENTITY_ID: ((ckanext__saml2auth__entity_id))
      SAML2_CERTIFICATE: ((saml2_certificate))
      NEW_RELIC_APP_NAME: ((new_relic_app_name))
      NEW_RELIC_HOST: gov-collector.newrelic.com
      NEW_RELIC_MONITOR_MODE: ((new_relic_monitor_mode))

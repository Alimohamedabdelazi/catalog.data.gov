From 1e573fce60e2ae7169fa9811c2e080ab7e02a883 Mon Sep 17 00:00:00 2001
From: Ian Ward <ian@excess.org>
Date: Tue, 16 Jun 2020 17:28:55 -0400
Subject: [PATCH] [#5443] simplify flatten, allow nesting >1 level

---
 ckan/lib/navl/dictization_functions.py | 15 +++++----------
 1 file changed, 5 insertions(+), 10 deletions(-)

diff --git a/ckan/lib/navl/dictization_functions.py b/ckan/lib/navl/dictization_functions.py
index 43cce72ed..397cddf95 100644
--- a/ckan/lib/navl/dictization_functions.py
+++ b/ckan/lib/navl/dictization_functions.py
@@ -410,24 +410,19 @@ def unflatten(data):
     for flattend_key in sorted(data.keys(), key=flattened_order_key):
         current_pos = unflattened
 
-        if (len(flattend_key) > 1
-                and not flattend_key[0] in convert_to_list
-                and not flattend_key[0] in unflattened):
-            convert_to_list.append(flattend_key[0])
-
         for key in flattend_key[:-1]:
             try:
                 current_pos = current_pos[key]
-            except KeyError:
+            except IndexError:
                 new_pos = {}
+                current_pos.append(new_pos)
+                current_pos = new_pos
+            except KeyError:
+                new_pos = []
                 current_pos[key] = new_pos
                 current_pos = new_pos
         current_pos[flattend_key[-1]] = data[flattend_key]
 
-    for key in convert_to_list:
-        unflattened[key] = [unflattened[key][s]
-                            for s in sorted(unflattened[key])]
-
     return unflattened
 
 
-- 
2.17.1
